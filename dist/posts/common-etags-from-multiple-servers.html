<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>bighappyface.io</title>

    <!-- Bootstrap Core CSS -->
    <link href="/css/main.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5C6QSW"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5C6QSW');</script>
    <!-- End Google Tag Manager -->

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">bighappyface.io</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/about">About</a>
                    </li>
                    <li>
                        <a href="/contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- If the current page is blog/ but not blog/index.ejsâ€¦ -->
    
      <!-- Render the partial blog/_nest -->
      <!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="intro-header" style="background-image: url('/img/server-room.jpg')">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Common ETags from multiple servers</h1>
          <h2 class="subheading"></h2>
          <span class="meta">Posted by David Porter on June 9, 2015</span>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <h2>Background</h2><p>ETags are HTTP headers used to minimize client-server traffic when browser cache headers are enabled and content hasn&#39;t changed.</p>
<p>An HTTP server will generate a unique value for an ETag based on various criteria and when a client, which has previously requested a given resource, requests the resource again, the HTTP server will compare the ETag value with the &quot;If-None-Match&quot; header submitted by the client to determine if the resource has changed.</p>
<p>If the resource is the same, a <code>304 Not Modified</code> response is returned with an empty body; otherwise, the request is fulfilled as if it were not cached.</p>
<h2>Problem</h2><p>The criteria used to generate an ETag value is typically server-specific. In the case of Apache web server, three pieces of information are used by default:</p>
<ul>
<li>INode (the most server-specific)</li>
<li>File size</li>
<li>Last modified time</li>
</ul>
<p>For more information on this, please visit the <a href="http://httpd.apache.org/docs/2.4/mod/core.html#fileetag">Apache documentation</a>.</p>
<p>Because INode is server-specific, a multi-server environment serving the same content will respond with different ETag values under default settings.</p>
<p>In practice, this isn&#39;t a big concern considering that the <code>Cache-Control</code> and <code>Expires</code> headers are the main source of information used to determine if a resource should be cached client-side, and for how long. If a resource is cached properly, no subsequent request is made to the server, hence no 304 is ever issued from the server as no request was made by the client. The only real benefit is to save the bytes over the wire in the event a resource expires in cache or a hard-refresh is issued client-side.</p>
<p>In an attempt to solve this problem, I have developed a simple proof of concept on how to achieve a common ETag value based strictly on the file size.</p>
<p><a href="https://github.com/bighappyface/common-etags">https://github.com/bighappyface/common-etags</a></p>
<p>The repo provides a Vagrant multi-machine configuration and provisions two identical web servers with Apache and a common HTML file. All information is contained in the README but is reproduced below for convenience:</p>
<ol>
<li>Ensure VirtualBox and Vagrant are installed</li>
<li>Ensure ports 8080 and 8081 are available for use</li>
<li>Clone this repo</li>
<li>Open a Terminal session and navigate to the clone directory</li>
<li>Run command <code>vagrant up</code></li>
<li>Compare ETag values between the two virtual boxes with cURL</li>
<li><code>curl -sI http://localhost:8080 | grep ETag</code></li>
<li><code>curl -sI http://localhost:8081 | grep ETag</code></li>
</ol>
<h2>Concerns</h2><p>Some concerns with this approach:</p>
<ol>
<li>If content changes and the file size remains the same, the server could issue a 304 and the user would never get the latest version. This is where the modified time comes into play. While very possible, I do not think this would happen often in practice as typically files are not changed unless something is added or removed, which would almost always affect the size. For an image, a single pixel change would affect the size. For a document, a single character change would affect the size.</li>
<li>Fixing the multiple-server ETag issue doesn&#39;t really solve a problem. If a client caches content, we are good to go, and the longer the cache, the better. I am all for saving bandwidth by returning 304s with empty bodies, but in practice, a strong cache policy prevents the unnecessary request/response involved with the 304, as well as the server-side comparison. Strong cache solves the real problem and actually improves performance whereas high-fidelity to 304s only saves on bandwidth in certain scenarios. It feels a little bit like diminishing returns, but at scale, it could have a significant impact.</li>
</ol>
<h2>Goals</h2><p>Some goals:</p>
<ol>
<li>ETags are part of the Google PageSpeed scoring criteria. This approach allows you to finely tune HTTP traffic and achieve strong scores.</li>
<li>The setup is vanilla Apache configuration.</li>
</ol>
<h2>Final thoughts</h2><p>I hope this post and repo are helpful to some of you out there. If anything, the Vagrant multi-machine facilities are super cool and provide for easy proof-of-concepts like this for easy digestion and brainstorming on other multi-machine scenarios typically only found in production. As far as ETags are concerned, I am personally indifferent about leaving them or synchronizing them, but I am interested in obtaining high PageSpeed scores to ward off naysayers.</p>
<p>Diving a little deeper into the tech, and finding ways to build examples, always provides excellent learning opportunities. Enjoy!</p>
      </div>
    </div>
  </div>
</article>

    

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                      <li>
                          <a href="https://github.com/bighappyface">
                              <span class="fa-stack fa-lg">
                                  <i class="fa fa-circle fa-stack-2x"></i>
                                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                              </span>
                          </a>
                      </li>

                      <li>
                          <a href="https://www.drupal.org/u/bighappyface">
                              <span class="fa-stack fa-lg">
                                  <i class="fa fa-circle fa-stack-2x"></i>
                                  <i class="fa fa-drupal fa-stack-1x fa-inverse"></i>
                              </span>
                          </a>
                      </li>
                      <li>
                          <a href="https://twitter.com/bighappyface">
                              <span class="fa-stack fa-lg">
                                  <i class="fa fa-circle fa-stack-2x"></i>
                                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                              </span>
                          </a>
                      </li>
                    </ul>
                    <p class="copyright text-muted">Copyright &copy; bighappyface.io 2016</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/js/bootstrap.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/js/clean-blog.min.js"></script>

</body>

</html>
